<!DOCTYPE html>

<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>index.coffee</h1>
        

        
      </div>

      
        
        <p>####################################################################</p>
<h2 id="imgrecog-js">IMGRecog.js</h2>
<p>####################################################################</p>

        
          <div class='highlight'><pre>
asyncLib = <span class="hljs-built_in">require</span> <span class="hljs-string">"async"</span>
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
os = <span class="hljs-built_in">require</span> <span class="hljs-string">"os"</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>
vision = <span class="hljs-built_in">require</span> <span class="hljs-string">"@google-cloud/vision"</span>
client = <span class="hljs-literal">null</span></pre></div>
        
      
        
        <p>Get current and bin executable folder.</p>

        
          <div class='highlight'><pre>currentFolder = process.cwd() + <span class="hljs-string">"/"</span>
homeFolder = os.homedir() + <span class="hljs-string">"/"</span>
executableFolder = path.dirname(<span class="hljs-built_in">require</span>.main.filename) + <span class="hljs-string">"/"</span></pre></div>
        
      
        
        <p>Collection of folders to scan.</p>

        
          <div class='highlight'><pre>folders = []</pre></div>
        
      
        
        <p>Collection of available scripts.</p>

        
          <div class='highlight'><pre>scripts = {}</pre></div>
        
      
        
        <p>File scan count.</p>

        
          <div class='highlight'><pre>counter = <span class="hljs-number">0</span></pre></div>
        
      
        
        <p>Create file processor queue  to parse files against Google Vision.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">queueProcessor</span> = <span class="hljs-params">(filepath, callback)</span> -&gt;</span> scanFile filepath, callback
fileQueue = asyncLib.queue queueProcessor, <span class="hljs-number">4</span></pre></div>
        
      
        
        <p>File processor queue will drain once we have processed all files.</p>

        
          <div class='highlight'><pre>fileQueue.drain = <span class="hljs-function">-&gt;</span> finishedQueue()</pre></div>
        
      
        
        <p>Default options.</p>

        
          <div class='highlight'><pre>options = {
    decimals: <span class="hljs-number">2</span>
    extensions: [<span class="hljs-string">"png"</span>, <span class="hljs-string">"jpg"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"gif"</span>, <span class="hljs-string">"bmp"</span>]
    limit: <span class="hljs-number">1000</span>
    force: <span class="hljs-literal">false</span>
    verbose: <span class="hljs-literal">false</span></pre></div>
        
      
        
        <p>Below are the available identification commands.</p>

        
          <div class='highlight'><pre>    labels: <span class="hljs-literal">false</span>
    landmarks: <span class="hljs-literal">false</span>
    logos: <span class="hljs-literal">false</span>
    safe: <span class="hljs-literal">false</span></pre></div>
        
      
        
        <p>Scripts to run after processing.</p>

        
          <div class='highlight'><pre>    scripts: []
}</pre></div>
        
      
        
        <p>Transforms safe search strings to scores.</p>

        
          <div class='highlight'><pre>likelyhood = {
    VERY_UNLIKELY: <span class="hljs-number">0.05</span>
    UNLIKELY: <span class="hljs-number">0.25</span>
    POSSIBLE: <span class="hljs-number">0.55</span>
    LIKELY: <span class="hljs-number">0.75</span>
    VERY_LIKELY: <span class="hljs-number">0.95</span>
}</pre></div>
        
      
        
        <p>Set start time (Unix timestamp).</p>

        
          <div class='highlight'><pre>startTime = Date.now()</pre></div>
        
      
        
        <p>Show help on command line (imgrecog.js -help).</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">showHelp</span> = -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"imgrecog.js &lt;options|script&gt; &lt;folders&gt;"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Options:"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -labels            detect labels"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -landmarks         detect landmarks"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -logos             detect logos"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -safe              detect safe search"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -all               detect all (same as enabling everything above)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -force       -f    reprocess existing files / overwrite tags"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -verbose     -v    enable verbose"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -help        -h    help me (this screen)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Scripts:"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -delete-memes      delete previously processed memes and screenshots"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  -delete-unsafe     delete previously processed adult and violent images"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"............................................................................."</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Examples:"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Detect labels and safe search on current directory"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  $ imgrecog.js -labels -safe"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Detect everything and overwrite tags on specific directories"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  $ imgrecog.js -all -f /home/someuser/images /home/someuser/photos"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Execute scripts to delete memes and unsafe images"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  $ imgrecog.js -delete-memes -delete-unsafe /home/someuser/photos"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"............................................................................."</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"The Google Vision API credentials must be set on a imgrecog.auth.json file."</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"If you wish to change the tool options, create a imgrecog.config.json file."</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Current options:"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  decimals (<span class="hljs-subst">#{options.decimals}</span>)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  extensions (<span class="hljs-subst">#{options.extensions.join(<span class="hljs-string">' '</span>)}</span>)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  limit (<span class="hljs-subst">#{options.limit}</span>)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  force (<span class="hljs-subst">#{options.force}</span>)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  verbose (<span class="hljs-subst">#{options.verbose}</span>)"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"#############################################################################"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span></pre></div>
        
      
        
        <p>Load scripts from /scripts folder.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getScripts</span> = -&gt;</span>
    scriptsPath = path.join __dirname, <span class="hljs-string">"scripts"</span>
    files = fs.readdirSync scriptsPath

    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> files
        <span class="hljs-keyword">if</span> path.extname(s) <span class="hljs-keyword">is</span> <span class="hljs-string">".js"</span>
            filename = s.substring <span class="hljs-number">0</span>, s.lastIndexOf(<span class="hljs-string">".js"</span>)
            scripts[filename] = <span class="hljs-built_in">require</span> <span class="hljs-string">"./scripts/<span class="hljs-subst">#{s}</span>"</span></pre></div>
        
      
        
        <p>Get parameters from command line.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getParams</span> = -&gt;</span>
    params = Array::slice.call process.argv, <span class="hljs-number">2</span></pre></div>
        
      
        
        <p>No parameters? Show help.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> params.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        showHelp()
        <span class="hljs-keyword">return</span> process.exit <span class="hljs-number">0</span></pre></div>
        
      
        
        <p>Parse parameters…</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> params
        <span class="hljs-keyword">switch</span> p
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-help"</span>
                showHelp()
                <span class="hljs-keyword">return</span> process.exit <span class="hljs-number">0</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-v"</span>, <span class="hljs-string">"-verbose"</span>
                options.verbose = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-f"</span>, <span class="hljs-string">"-force"</span>
                options.force = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-all"</span>
                options.labels = <span class="hljs-literal">true</span>
                options.landmarks = <span class="hljs-literal">true</span>
                options.logos = <span class="hljs-literal">true</span>
                options.safe = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-labels"</span>
                options.labels = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-landmarks"</span>
                options.landmarks = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-logos"</span>
                options.logos = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">"-safe"</span>
                options.safe = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">else</span>
                filename = p.substring <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> scripts[filename]?
                    options.scripts.push filename
                <span class="hljs-keyword">else</span>
                    folders.push p</pre></div>
        
      
        
        <p>If no folders were passed, search on current directory.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> folders.length &lt; <span class="hljs-number">1</span>
        folders.push currentFolder

    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> folders
        <span class="hljs-keyword">if</span> f.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">"-"</span>
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Abort! Invalid option: <span class="hljs-subst">#{f}</span>. Use -help to get a list of available options."</span>
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
            <span class="hljs-keyword">return</span> process.exit <span class="hljs-number">0</span></pre></div>
        
      
        
        <p>Call the Vision API and return result so we can process tags.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">apiResult</span> = <span class="hljs-params">(filepath, apiMethod, key)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise (resolve, reject) -&gt;
        <span class="hljs-keyword">try</span>
            result = <span class="hljs-keyword">await</span> client[apiMethod] filepath
            resolve result[<span class="hljs-number">0</span>][key]
        <span class="hljs-keyword">catch</span> ex
            reject ex</pre></div>
        
      
        
        <p>Scan and process image file.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">scanFile</span> = <span class="hljs-params">(filepath, callback)</span> -&gt;</span>
    outputPath = filepath + <span class="hljs-string">".tags"</span>
    tags = {}</pre></div>
        
      
        
        <p>File was processed before?</p>

        
          <div class='highlight'><pre>    exists = fs.existsSync outputPath

    <span class="hljs-keyword">if</span> exists
        <span class="hljs-keyword">if</span> options.force
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  <span class="hljs-subst">#{filepath}</span>"</span>, <span class="hljs-string">"already processed, force overwrite"</span> <span class="hljs-keyword">if</span> options.verbose
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  <span class="hljs-subst">#{filepath}</span>"</span>, <span class="hljs-string">"already processed, skip"</span> <span class="hljs-keyword">if</span> options.verbose
            <span class="hljs-keyword">return</span> callback()</pre></div>
        
      
        
        <p>Increase scan counter.</p>

        
          <div class='highlight'><pre>    counter++

    <span class="hljs-keyword">if</span> counter <span class="hljs-keyword">is</span> options.limit
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Limit <span class="hljs-subst">#{counter}</span> reached! Will NOT process more files..."</span>
        <span class="hljs-keyword">return</span> callback()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> counter &gt; options.limit
        <span class="hljs-keyword">return</span> callback()</pre></div>
        
      
        
        <p>Detect labels?</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> options.labels
        <span class="hljs-keyword">try</span>
            result = <span class="hljs-keyword">await</span> apiResult filepath, <span class="hljs-string">"labelDetection"</span>, <span class="hljs-string">"labelAnnotations"</span>
            logtext = []</pre></div>
        
      
        
        <p>Add labels as tags.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> result
                score = label.score.toFixed options.decimals
                logtext.push <span class="hljs-string">"<span class="hljs-subst">#{label.description}</span>:<span class="hljs-subst">#{score}</span>"</span>
                tags[label.description] = score

            <span class="hljs-keyword">if</span> options.verbose <span class="hljs-keyword">and</span> logtext.length &gt; <span class="hljs-number">0</span>
                <span class="hljs-built_in">console</span>.log filepath, <span class="hljs-string">"labels"</span>, logtext.join(<span class="hljs-string">", "</span>)
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error filepath, <span class="hljs-string">"labels"</span>, ex</pre></div>
        
      
        
        <p>Detect landmarks?</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> options.landmarks
        <span class="hljs-keyword">try</span>
            result = <span class="hljs-keyword">await</span> apiResult filepath, <span class="hljs-string">"landmarkDetection"</span>, <span class="hljs-string">"landmarkAnnotations"</span>
            logtext = []</pre></div>
        
      
        
        <p>Add landmarks as tags.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> result
                <span class="hljs-keyword">if</span> r.landmarks
                    <span class="hljs-keyword">for</span> land <span class="hljs-keyword">in</span> r.landmarks
                        score = land.score.toFixed options.decimals
                        logtext.push <span class="hljs-string">"<span class="hljs-subst">#{land.description}</span>:<span class="hljs-subst">#{score}</span>"</span>
                        tags[land.description] = score

            <span class="hljs-keyword">if</span> options.verbose <span class="hljs-keyword">and</span> logtext.length &gt; <span class="hljs-number">0</span>
                <span class="hljs-built_in">console</span>.log filepath, <span class="hljs-string">"landmarks"</span>, logtext.join(<span class="hljs-string">", "</span>)
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error filepath, <span class="hljs-string">"landmarks"</span>, ex</pre></div>
        
      
        
        <p>Detect logos?</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> options.logos
        <span class="hljs-keyword">try</span>
            result = <span class="hljs-keyword">await</span> apiResult filepath, <span class="hljs-string">"logoDetection"</span>, <span class="hljs-string">"logoAnnotations"</span>
            logtext = []</pre></div>
        
      
        
        <p>Add logos as tags.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">for</span> logo <span class="hljs-keyword">in</span> result
                score = logo.score.toFixed options.decimals
                logtext.push <span class="hljs-string">"<span class="hljs-subst">#{logo.description}</span>:<span class="hljs-subst">#{score}</span>"</span>
                tags[logo.description] = score

            <span class="hljs-keyword">if</span> options.verbose <span class="hljs-keyword">and</span> logtext.length &gt; <span class="hljs-number">0</span>
                <span class="hljs-built_in">console</span>.log filepath, <span class="hljs-string">"logos"</span>, logtext.join(<span class="hljs-string">", "</span>)
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error filepath, <span class="hljs-string">"logos"</span>, ex</pre></div>
        
      
        
        <p>Detect safe search?</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> options.safe
        <span class="hljs-keyword">try</span>
            result = <span class="hljs-keyword">await</span> apiResult filepath, <span class="hljs-string">"safeSearchDetection"</span>, <span class="hljs-string">"safeSearchAnnotation"</span>
            logtext = []</pre></div>
        
      
        
        <p>Add safe search labels as tags.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> result
                score = likelyhood[value]
                logtext.push <span class="hljs-string">"<span class="hljs-subst">#{key}</span>:<span class="hljs-subst">#{score}</span>"</span>
                tags[key] = score

            <span class="hljs-keyword">if</span> options.verbose <span class="hljs-keyword">and</span> logtext.length &gt; <span class="hljs-number">0</span>
                <span class="hljs-built_in">console</span>.log filepath, <span class="hljs-string">"safe"</span>, logtext.join(<span class="hljs-string">", "</span>)
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error filepath, <span class="hljs-string">"safe"</span>, ex</pre></div>
        
      
        
        <p>Output data to JSON.</p>

        
          <div class='highlight'><pre>    outputData = JSON.stringify tags, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span></pre></div>
        
      
        
        <p>Write results to .json file.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">try</span>
        fs.writeFile outputPath, outputData, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> err?
                <span class="hljs-built_in">console</span>.error filepath, <span class="hljs-string">"write file"</span>, err
            <span class="hljs-keyword">else</span>
                <span class="hljs-built_in">console</span>.log filepath, <span class="hljs-string">"processed <span class="hljs-subst">#{Object.keys(tags).length}</span> tags"</span>

            callback err
    <span class="hljs-keyword">catch</span> ex
        <span class="hljs-built_in">console</span>.error filepath, <span class="hljs-string">"write file"</span>, ex
        callback ex</pre></div>
        
      
        
        <p>Scan a folder to match duplicates.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">scanFolder</span> = <span class="hljs-params">(folder, callback)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">scanner</span> = <span class="hljs-params">(file)</span> -&gt;</span>
        filepath = path.join folder, file
        ext = path.extname(filepath).toLowerCase().replace <span class="hljs-string">"."</span>, <span class="hljs-string">""</span>

        <span class="hljs-keyword">try</span>
            stats = fs.statSync filepath

            <span class="hljs-keyword">if</span> stats.isDirectory()
                scanFolder filepath
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> options.extensions.indexOf(ext) &gt;= <span class="hljs-number">0</span>
                    <span class="hljs-keyword">if</span> counter &lt; options.limit
                        fileQueue.push filepath
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> options.verbose <span class="hljs-keyword">and</span> ext <span class="hljs-keyword">isnt</span> <span class="hljs-string">"tags"</span>
                    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"  <span class="hljs-subst">#{filepath}</span>"</span>, <span class="hljs-string">"skip (invalid extension)"</span>
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Error reading <span class="hljs-subst">#{filepath}</span>: <span class="hljs-subst">#{ex}</span>"</span></pre></div>
        
      
        
        <p>Make sure we have the correct folder path.</p>

        
          <div class='highlight'><pre>    folder = executableFolder + folder <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> path.isAbsolute folder

    <span class="hljs-keyword">try</span>
        contents = fs.readdirSync folder

        <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Scanning <span class="hljs-subst">#{folder}</span>"</span>

        <span class="hljs-keyword">if</span> options.verbose
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Found <span class="hljs-subst">#{contents.length}</span> files"</span>

        i = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> i &lt; contents.length
            scanner contents[i]
            i++

        callback <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> callback?
    <span class="hljs-keyword">catch</span> ex
        <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Error reading <span class="hljs-subst">#{folder}</span>: <span class="hljs-subst">#{ex}</span>"</span>
        callback ex <span class="hljs-keyword">if</span> callback?</pre></div>
        
      
        
        <p>Finished processing file queue.</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">finishedQueue</span> = <span class="hljs-params">(err, result)</span> -&gt;</span>
    duration = (Date.now() - startTime) / <span class="hljs-number">1000</span>

    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Finished processing images after <span class="hljs-subst">#{duration}</span> seconds"</span>

    <span class="hljs-keyword">if</span> options.scripts.length &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> options.scripts
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Running script <span class="hljs-subst">#{s}</span> ..."</span>
            <span class="hljs-keyword">try</span>
                scriptResult = <span class="hljs-keyword">await</span> scripts[s] folders
            <span class="hljs-keyword">catch</span> ex
                <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Error running <span class="hljs-subst">#{s}</span>"</span>, ex

        <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Finished running scripts"</span></pre></div>
        
      
        
        <p>Bye!</p>

        
          <div class='highlight'><pre>    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span></pre></div>
        
      
        
        <p>Run it!</p>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">run</span> = -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"#############################################################################"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"# IMGRecog.js"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"#############################################################################"</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span></pre></div>
        
      
        
        <p>Get valid filenames for the configuration and key files.</p>

        
          <div class='highlight'><pre>    configExecutable = path.join currentFolder, <span class="hljs-string">"imgrecog.config.json"</span>
    configHome = path.join currentFolder, <span class="hljs-string">"imgrecog.config.json"</span>
    configCurrent = path.join currentFolder, <span class="hljs-string">"imgrecog.config.json"</span>
    credentialsExecutable = path.join executableFolder, <span class="hljs-string">"imgrecog.auth.json"</span>
    credentialsHome = path.join homeFolder, <span class="hljs-string">"imgrecog.auth.json"</span>
    credentialsCurrent = path.join currentFolder, <span class="hljs-string">"imgrecog.auth.json"</span></pre></div>
        
      
        
        <p>Load options from config file?</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">try</span>
        <span class="hljs-keyword">if</span> fs.existsSync configCurrent
            configPath = configCurrent
         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> fs.existsSync configHome
            configPath = configHome
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> fs.existsSync configExecutable
            configPath = configExecutable

        <span class="hljs-keyword">if</span> configPath?
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Using config from <span class="hljs-subst">#{configPath}</span>"</span>

            configJson = fs.readFileSync configPath, <span class="hljs-string">"utf8"</span>
            configJson = JSON.parse configJson
            options[key] = value <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> configJson

    <span class="hljs-keyword">catch</span> ex
        <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Can't load <span class="hljs-subst">#{configPath}</span>"</span>, ex</pre></div>
        
      
        
        <p>Load available scripts.</p>

        
          <div class='highlight'><pre>    getScripts()</pre></div>
        
      
        
        <p>Get the passed parameters. If -help, it will end here.</p>

        
          <div class='highlight'><pre>    getParams()</pre></div>
        
      
        
        <p>Passed options.</p>

        
          <div class='highlight'><pre>    arr = []
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> options
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>
            arr.push key
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> value <span class="hljs-keyword">isnt</span> <span class="hljs-literal">false</span>
            arr.push <span class="hljs-string">"<span class="hljs-subst">#{key}</span>: <span class="hljs-subst">#{value}</span>"</span>

    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Options: <span class="hljs-subst">#{arr.join(<span class="hljs-string">" | "</span>)}</span>"</span></pre></div>
        
      
        
        <p>Create client, checking if a credentials.json file exists.
Only if any of the identification commmands was passed.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> options.labels <span class="hljs-keyword">or</span> options.landmarks <span class="hljs-keyword">or</span> options.logos <span class="hljs-keyword">or</span> options.safe
        <span class="hljs-keyword">try</span>
            <span class="hljs-keyword">if</span> fs.existsSync credentialsCurrent
                client = <span class="hljs-keyword">new</span> vision.ImageAnnotatorClient {keyFilename: credentialsCurrent}
                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Using credentials from <span class="hljs-subst">#{credentialsCurrent}</span>"</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> fs.existsSync credentialsHome
                client = <span class="hljs-keyword">new</span> vision.ImageAnnotatorClient {keyFilename: credentialsHome}
                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Using credentials from <span class="hljs-subst">#{credentialsHome}</span>"</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> fs.existsSync credentialsExecutable
                client = <span class="hljs-keyword">new</span> vision.ImageAnnotatorClient {keyFilename: credentialsExecutable}
                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Using credentials from <span class="hljs-subst">#{credentialsExecutable}</span>"</span>
            <span class="hljs-keyword">else</span>
                client = <span class="hljs-keyword">new</span> vision.ImageAnnotatorClient()
                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Using credentials from environment variables"</span>
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Could not create a Vision API client, make sure you have defined credentials on a imgrecog.json file or environment variables."</span>, ex
            <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
            process.exit <span class="hljs-number">0</span>

        folderTasks = []</pre></div>
        
      
        
        <p>Iterate and scan search folders.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">for</span> folder <span class="hljs-keyword">in</span> folders
            <span class="hljs-keyword">do</span> (folder) -&gt; folderTasks.push (callback) -&gt; scanFolder folder, callback</pre></div>
        
      
        
        <p>Run folder scanning tasks in parallel after 1 second so we have time to confirm client credentials.</p>

        
          <div class='highlight'><pre><span class="hljs-function">        <span class="hljs-title">delayedScan</span> = -&gt;</span>
            asyncLib.parallelLimit folderTasks, <span class="hljs-number">2</span>, <span class="hljs-function">-&gt;</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> fileQueue.started
                    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
                    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"No valid images were found!"</span>
                    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>

        setTimeout delayedScan, <span class="hljs-number">1200</span>
    <span class="hljs-keyword">else</span>
        finishedQueue()</pre></div>
        
      
        
        <p>Unhandled rejections goes here.</p>

        
          <div class='highlight'><pre>process.<span class="hljs-literal">on</span> <span class="hljs-string">"unhandledRejection"</span>, <span class="hljs-function"><span class="hljs-params">(reason, p)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> options.verbose
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"ERROR!"</span>
        <span class="hljs-built_in">console</span>.log reason
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"ERROR!"</span>, reason.message <span class="hljs-keyword">or</span> reason.code <span class="hljs-keyword">or</span> reason

    <span class="hljs-built_in">console</span>.log <span class="hljs-string">""</span>
    process.exit <span class="hljs-number">0</span></pre></div>
        
      
        
        <h2 id="run-baby-run-">Run baby run!</h2>

        
      
        
        
        
          <div class='highlight'><pre>run()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
